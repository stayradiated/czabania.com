<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Wireguard Port Forwarding :: george.czabania</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="I&amp;rsquo;ve been trying to setup Wireguard. It&amp;rsquo;s one of those things where it looks like it should be quite easy, but if it doesn&amp;rsquo;t work you have no idea why.
I have a computer sitting in our office, and I want to be to access it outside of our office over the internet. Unfortunately, the office is behind a NAT and I can&amp;rsquo;t just go exposing ports.
SO, I used DigitalOcean to create an tiny Ubuntu server in the cloud."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://george.czabania.com/posts/2019_03_18/" />


<link rel="stylesheet" href="https://george.czabania.com/assets/style.css">


<link rel="stylesheet" href="https://george.czabania.com/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://george.czabania.com/img/apple-touch-icon-144-precomposed.png">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Wireguard Port Forwarding :: george.czabania — " />
<meta name="twitter:description" content="I&amp;rsquo;ve been trying to setup Wireguard. It&amp;rsquo;s one of those things where it looks like it should be quite easy, but if it doesn&amp;rsquo;t work you have no idea why.
I have a computer sitting in our office, and I want to be to access it outside of our office over the internet. Unfortunately, the office is behind a NAT and I can&amp;rsquo;t just go exposing ports.
SO, I used DigitalOcean to create an tiny Ubuntu server in the cloud." />
<meta name="twitter:site" content="https://george.czabania.com/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image" content="">


<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Wireguard Port Forwarding :: george.czabania — ">
<meta property="og:description" content="I&amp;rsquo;ve been trying to setup Wireguard. It&amp;rsquo;s one of those things where it looks like it should be quite easy, but if it doesn&amp;rsquo;t work you have no idea why.
I have a computer sitting in our office, and I want to be to access it outside of our office over the internet. Unfortunately, the office is behind a NAT and I can&amp;rsquo;t just go exposing ports.
SO, I used DigitalOcean to create an tiny Ubuntu server in the cloud." />
<meta property="og:url" content="https://george.czabania.com/posts/2019_03_18/" />
<meta property="og:site_name" content="Wireguard Port Forwarding" />
<meta property="og:image" content="">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2019-03-19 20:23:55 &#43;1300 NZDT" />











</head>
<body class="">


<div class="container center">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    george.czabania
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
</header>


  <div class="content">
    
  <div class="post">
    <h1 class="post-title"><a href="https://george.czabania.com/posts/2019_03_18/">Wireguard Port Forwarding</a></h1>
    <div class="post-meta">
      <span class="post-date">
        2019-03-19
      </span>
      
    </div>

    

    

    <div class="post-content">
      

<p>I&rsquo;ve been trying to setup Wireguard. It&rsquo;s one of those things where it looks
like it should be quite easy, but if it doesn&rsquo;t work you have no idea why.</p>

<p>I have a computer sitting in our office, and I want to be to access it outside
of our office over the internet. Unfortunately, the office is behind a NAT and
I can&rsquo;t just go exposing ports.</p>

<p>SO, I used DigitalOcean to create an tiny Ubuntu server in the cloud. This
server has a static IP address, and I have control over which ports are
accessible.</p>

<p>My plan is to use Wireguard to create a VPN between the office computer and the
cloud server. Then I can forward traffic from the server to the office, quickly
and securely.</p>

<p>From now on, I will refer to the office computer as the &ldquo;client&rdquo; and the
DigitalOcean server as the &ldquo;server&rdquo;.</p>

<blockquote>
<p>You will need to be root for most of these commands, so I have dropped the
<code>sudo</code> prefix.</p>
</blockquote>

<h2 id="installing-wireguard">Installing Wireguard</h2>

<h3 id="ubuntu">Ubuntu</h3>

<pre><code class="language-bash">add-apt-repository ppa:wireguard/wireguard
apt-get update
apt-get install wireguard-dkms wireguard-tools
</code></pre>

<h2 id="arch-linux">Arch Linux</h2>

<p>You can also use <code>systemd-networkd</code> to configure wireguard, but I think it just
makes it even more complicated.</p>

<pre><code class="language-bash">pacman -S wireguard-arch wireguard-tools
</code></pre>

<h2 id="generating-private-pubic-keys">Generating private/pubic keys</h2>

<p>You need to do this on both the client and the server.</p>

<pre><code class="language-bash">umask 077
cd /etc/wireguard
wg genkey &gt; privatekey
wg pubkey &lt; privatekey &gt; publickey
</code></pre>

<h2 id="configuration">Configuration</h2>

<p>Everything in <code>&lt;&gt;</code> is a variable and should be replaced.</p>

<h3 id="server">Server</h3>

<pre><code class="language-cfg">[Interface]
Address = &lt;SERVER_ADDRESS&gt;
PrivateKey = &lt;SERVER_PRIVATE_KEY&gt;
ListenPort = &lt;SERVER_PORT&gt;

[Peer]
PublicKey = &lt;CLIENT_PUBLIC_KEY&gt;
AllowedIPs = &lt;CLIENT_ADDRESS&gt;/32
</code></pre>

<h3 id="client">Client</h3>

<pre><code class="language-cfg">[Interface]
Address = &lt;CLIENT_ADDRESS&gt;
PrivateKey = &lt;CLIENT_PRIVATE_KEY&gt;

[Peer]
Endpoint = &lt;SERVER_IP&gt;:&lt;SERVER_PORT&gt;
PublicKey = &lt;SERVER_PUBLIC_KEY&gt;
AllowedIPs = &lt;SERVER_ADDRESS&gt;/32
PersistentKeepalive = 25
</code></pre>

<h3 id="variables">Variables</h3>

<p>You need to create a new IP address for the client and server. I think this can
be any address that isn&rsquo;t used.</p>

<ul>
<li><code>&lt;SERVER_ADDRESS&gt;</code>: <code>10.11.12.1</code></li>
<li><code>&lt;CLIENT_ADDRESS&gt;</code>: <code>10.11.12.2</code></li>
</ul>

<p>These are the private and public keys from the different computers. The
following are ones I have generated just for this article, and should not be
copy/pasted:</p>

<ul>
<li><code>&lt;CLIENT_PRIVATE_KEY&gt;</code>: <code>OOsIW12TAKkv6yec5gp6nNC3TN53/PyajifXHHz1t08=</code></li>
<li><code>&lt;CLIENT_PUBLIC_KEY&gt;</code>: <code>8xMY/IkM2pEn4ADjEQM+rQLjSbscg4hrqERNqvXAbyg=</code></li>
<li><code>&lt;SERVER_PRIVATE_KEY&gt;</code>: <code>YGSeVUzy6N0KqcvMeYmE2OJXntJCZOq682WYS6elcm4=</code></li>
<li><code>&lt;SERVER_PUBLIC_KEY&gt;</code>: <code>rczpxKe5VPMrjTPZ13/jwCOYQkZEVzgkVFJPeyK2sn8=</code></li>
</ul>

<p>Your server should have a static IP. You will also need to pick a port number,
and make sure that it isn&rsquo;t blocked by any firewall.</p>

<p>I like to use
<a href="https://www.random.org/integers/?num=1&amp;min=5001&amp;max=49151&amp;col=5&amp;base=10&amp;format=html&amp;rnd=new">random.org</a>
to pick port numbers.</p>

<ul>
<li><code>&lt;SERVER_IP&gt;</code>: <code>175.198.17.240</code></li>
<li><code>&lt;SERVER_PORT&gt;</code>: <code>45776</code></li>
</ul>

<h3 id="example-server-config">Example Server Config</h3>

<pre><code class="language-cfg">[Interface]
Address = 10.11.12.1
PrivateKey = YGSeVUzy6N0KqcvMeYmE2OJXntJCZOq682WYS6elcm4=
ListenPort = 45776

[Peer]
PublicKey = rczpxKe5VPMrjTPZ13/jwCOYQkZEVzgkVFJPeyK2sn8=
AllowedIPs = 10.11.12.2/32
</code></pre>

<h3 id="example-client-config">Example Client Config</h3>

<pre><code class="language-cfg">[Interface]
Address = 10.11.12.2
PrivateKey = OOsIW12TAKkv6yec5gp6nNC3TN53/PyajifXHHz1t08=

[Peer]
Endpoint = 175.198.17.240:45776
PublicKey = 175.198.17.240:45776
AllowedIPs = 10.11.12.1/32
PersistentKeepalive = 25
</code></pre>

<h2 id="starting-wireguard">Starting wireguard</h2>

<pre><code class="language-bash"># start wireguard using our config file
systemctl start wg-quick@wg0

# set wireguard to start automatically at boot
systemctl enable wg-quick@wg0
</code></pre>

<h2 id="checking-status">Checking status</h2>

<pre><code class="language-bash">wg show
</code></pre>

<p>You should see information about the peer.</p>

<pre><code>interface: wg0
  public key: 8xMY/IkM2pEn4ADjEQM+rQLjSbscg4hrqERNqvXAbyg=
  private key: (hidden)
  listening port: 36494

peer: rczpxKe5VPMrjTPZ13/jwCOYQkZEVzgkVFJPeyK2sn8=
  endpoint: 175.198.17.240:45776
  allowed ips: 10.11.12.1/32
  latest handshake: 9 seconds ago
  transfer: 560.43 KiB received, 34.57 KiB sent
  persistent keepalive: every 25 seconds
</code></pre>

<h2 id="pinging">Pinging</h2>

<p>Run this on the client to ping the server.</p>

<pre><code class="language-bash">ping 10.11.12.1
</code></pre>

<p>Run this on the server to ping the client.</p>

<pre><code class="language-bash">ping 10.11.12.2
</code></pre>

<h2 id="port-forwarding">Port Forwarding</h2>

<p>Now that we have a connection between the client and the server, we can setup
port forwarding.</p>

<p>This will forward any incoming traffic to the server on $PORT to the client.</p>

<p>I don&rsquo;t really understand how <code>iptables</code> works, I just copied this from:
<a href="https://golb.hplar.ch/2019/01/expose-server-vpn.html">https://golb.hplar.ch/2019/01/expose-server-vpn.html</a></p>

<pre><code class="language-bash">#!/usr/bin/env bash

PORT=6379
SERVER_ADDRESS=10.11.12.1
CLIENT_ADDRESS=10.11.12.2

iptables -P FORWARD DROP

iptables -A FORWARD -i eth0 -o wg0 -p tcp --syn --dport ${PORT} -m conntrack --ctstate NEW -j ACCEPT
iptables -A FORWARD -i eth0 -o wg0 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -i wg0 -o eth0 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

iptables -t nat -A PREROUTING -i eth0 -p tcp --dport ${PORT} -j DNAT --to-destination ${CLIENT_ADDRESS}
iptables -t nat -A POSTROUTING -o wg0 -p tcp --dport ${PORT} -d ${CLIENT_ADDRESS} -j SNAT --to-source ${SERVER_ADDRESS}
</code></pre>

<h3 id="saving-ip-tables">Saving IP Tables</h3>

<p>This will persist your iptables rules in case the server restarts.</p>

<pre><code class="language-bash">apt install iptables-persistent
</code></pre>

    </div>
    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
          
            <span class="button next">
              <a href="https://george.czabania.com/posts/2019_03_17/">
                <span class="button__text">Rooibos Chai Tea</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
    

    

  </div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2019 Powered by <a href="http://gohugo.io">Hugo</a></span>
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://george.czabania.com/assets/main.js"></script>
<script src="https://george.czabania.com/assets/prism.js"></script>





  
</div>

</body>
</html>
